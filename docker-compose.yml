version: '2'
services:
  prod: &PROD
    image: python:2.7.13
    command: ./devops/activate_then ./devops/run_webserver.sh
    ports:
      - 9000:9000
    environment: &PROD_ENV
      PORT: 9000
      DJANGO_SETTINGS_MODULE: atf_eregs.settings.base
      TMPDIR: /tmp
      STATIC_ROOT: frontend_build
      VCAP_APPLICATION: >
        {"uris": ["localhost", "0.0.0.0", "127.0.0.1"]}
    volumes:
      - $PWD:/usr/src/app
      - prod_libs:/usr/src/app/.venv/
    working_dir: /usr/src/app
    stdin_open: true
    tty: true
  dev: &DEV
    <<: *PROD
    ports:
      - 8000:8000
    environment:
      <<: *PROD_ENV
      DEBUG: "true"
      PORT: 8000
    volumes:
      - $PWD:/usr/src/app
      - dev_libs:/usr/src/app/.venv/


  #---- Commands ----
  manage.py:
    <<: *DEV
    entrypoint: ./devops/activate_then ./manage.py
    command: ''
    ports: []

  py.test:
    <<: *DEV
    entrypoint: ./devops/activate_then py.test
    command: ''
    ports: []

  flake8:
    <<: *DEV
    entrypoint: ./devops/activate_then flake8
    command: ''
    ports: []

  pip-compile:
    <<: *DEV
    entrypoint: ./devops/activate_then pip-compile
    command: ''
    ports: []

  bandit:
    <<: *DEV
    entrypoint: ./devops/activate_then bandit
    command: ''
    ports: []

  grunt:
    image: node:6
    volumes:
      - $PWD:/usr/src/app
      - npm_libs:/usr/src/app/frontend_build/node_modules/
    working_dir: /usr/src/app/frontend_build/
    entrypoint: ../devops/deps_ok_then ./node_modules/.bin/grunt

volumes:
  database_data:
  prod_libs:
  dev_libs:
  npm_libs:
